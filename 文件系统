文件管理
* 文件与文件系统
* 文件的存储介质
* 磁盘空间管理
* 文件控制块及文件目录
* 文件的物理结构
* 文件系统的实现
* 文件系统实例unix


文件与文件系统

文件是磁盘的抽象，是指一组带标识（标识即为文件名）的，在逻辑上有完整意义的信息项的序列。
信息项：构成文件内容的基本单位（单个字节或多个字节），各个信息项之间具有顺序关系。
文件内容的意义：由文件建立者和使用者解释
（信息项0，信息项1，信息项2，...,信息项n-1)
读写指针指向某个信息项

如何设计一个文件系统？

用户角度：文件系统如何呈现在用户面前（一个文件的组织，命名，保护文件，实施操作）
操作系统：组织，管理文件（文件的描述，分类；文件目录的实现，存储空间的管理，文件的物理地址，
磁盘实际运作方式（与设备管理的接口），文件系统性能）

文件系统

操作系统中统一管理信息资源的一种软件，管理文件的存储，检索，更新，提供安全可靠的共享和保护手段，并且方便用户使用。
*统一管理磁盘空间，实施磁盘空间的分配与回收
*实现文件的按名存取（名字空间 映射 磁盘空间）
*实现文件信息的共享，并提供文件的保护，保密手段
*向用户提供一个方便使用，易于维护的接口，并向用户提供有关统计信息
*提高文件系统的性能
*提供与I/O系统的统一接口

文件的分类（UNIX) 按照文件性质和用途分类

普通文件regular: 包含了用户的信息，一般为ASCII或二进制文件
目录文件directory:管理文件系统的系统文件
特殊文件special file:字符设备文件：和输入输出有关，用于模仿串行I/O设备，
例如终端，打印机，网卡等；块设备文件：磁盘

文件的逻辑结构（用户角度看文件，由用户的访问方式确定）

典型的文件逻辑结构和文件存取
* 流式文件：构成文件的基本单位是字符
文件是有逻辑意义，无结构的一串字符的集合
*记录式文件：文件由若干个记录组成，可以按记录进行读，写查找等操作
每条记录有其内部结构
1. 顺序存取
2. 随机存取（提供读写位置（当前位置）例如unix seek操作）

文件的存储介质

* 典型的存储介质
磁盘（包括固态盘ssd),磁带，光盘，u盘等
* 物理块（块block，簇cluster）
1. 信息存储，传输，分配的独立单位
2. 存储设备划分为大小相等的物理块，统一编号
例如：典型磁盘结构
任何时刻只有一个磁头处于活动状态：输入输出数据流以位串形式出现
物理地址形式：磁头号（盘面号），磁道号（柱面号），扇区号
扇区：标题（10字节），数据（512字节），ECC纠错信息（12-16字节）

磁盘访问

一次访盘请求：
读/写，磁盘地址（设备号，柱面号，磁头号，扇区号），内存地址（源/目）
完成这个过程由三个动作组成：
1.寻道（时间）： 磁头移动定位到指定磁道
2. 旋转延迟（时间）： 等待指定扇区从磁头下方经过
3. 数据传输（时间）：数据在磁盘与内存之间的实际传输

磁盘空间管理

相关的数据结构
1. 位图
a. 用一串二进制位反映磁盘空间中分配使用情况，每个物理块对应一位，分配的物理块为0，否则为1
b. 申请物理块时，可以在位示图中查找为1的位，返回对应物理块号
c. 归还时，将对应位转置1
2. 空闲块表
a. 将所有空闲块记录在一个表中，即空闲块表
b. 主要两项内容：起始块号，块数
3. 空闲块链表
a. 把所有空闲块链成一个链
b. 扩展：成组链接法

磁盘地址与块号的转换
已知块号，则磁盘地址：
柱面号=【块号/（磁头数 x 扇区数）】
磁头号=【（块号mod(磁头数 x 扇区数））/扇区数】
扇区号=（块号mod(磁头数 x 扇区数）mod 扇区数
已知磁盘地址：
块号=柱面号 x (磁头数 x 扇区数） + 磁头号 x 扇区数 + 扇区号
位图计算公式：
已知字号i,位号j: 块号=ix字长+j
已知块号：字号=【块号/字长】 位号=块号mod字长

UNIX成组链接法-分配算法（分配一个空闲块）
查L单元（空闲块数）
a. 当空闲块数>1 i=L+空闲块数；从i单元得到一个空闲块号；把该块分配给申请者；空闲块数减1
b. 当空闲块数=1 取出L+1单元内容（一组的第一块号或0）；其值=0无空闲块号，申请者等待，
其值不等于零，把该块内容复制到专用块，该块分配给申请者；把专用块内容读到内存L开始的区域

UNIX成组链接法-回收算法（归还一个块）
查L单元的空闲块数
a. 当空闲块数<100 空闲块数加1； j:=L+空闲块数；归还块号填入j单元。
b. 当空闲块数=100 则把内存中登记的信息写入归还块中；把归还块号填入L+1单元，
将L单元置成1。


文件控制块和文件目录
1. 文件控制块（File Control Block)
为管理文件而设置的数据结构，保存管理文件所需的所有有关信息
（文件属性或元数据）
2. 常用属性
文件名，文件号，文件大小，文件地址，创建时间，最后修改时间，最后访问时间
保护，口令，创建者，当前拥有者，文件类型，共享计数，各种标志（
（只读，隐藏，系统，归档，ASCII/二进制，顺序/随机访问，临时文件，锁）

基本文件操作
create, delete, open, close, read, write
append, seek, get attribute, set attribute, rename

文件目录，目录项与目录文件

文件目录
1. 统一管理每个文件的元数据，以支持文件名到文件物理地址的转换
2. 将所有文件的管理信息组织在一起，即构成文件目录
目录文件
1. 将文件目录以文件的形式存放在磁盘
目录项
1. 构成文件目录的基本单元
2. 目录项可以是FCB, 目录是文件控制块的有序集合

文件目录结构的演化
一级目录结构-》二级目录结构-〉树形目录结构（当前）

与目录相关的概念
1. 路径名（文件名）
a. 绝对路径名：从根目录开始
b. 相对路径名：从当前目录开始
2. 当前目录/工作目录
3. 目录操作
a. 创建目录，删除目录
b. 读目录，写目录，改名，复制

目录文件之间的关联

文件的物理结构
文件在存储介质上的存放方式
主要解决两个问题：
1. 假设一个文件被划分成N块，这N块在磁盘上是怎么存放的？
2. 其地址（块号/簇号）在FCB中是怎么记录的？
1.连续（顺序）结构
a. 文件的信息存放在若干连续的物理块中
优点：简单；支持顺序存取和随机存取；所需的磁盘寻道次数和寻道时间最少；
可以同时读入多个块，检索一个块也很容易
缺点：文件不能动态增长，预留空间：浪费或者重新分配和移动；不利于文件插入和删除；
外部碎片：紧缩技术
2.链接结构
a. 一个文件的信息存放在若干个不连续的物理块中，各块之间通过指针连接，前一个
物理块指向下一个物理块
优点：提高了磁盘空间利用率，不存在外碎片问题；有利于文件插入和删除；
有利于文件动态扩充
缺点：存取速度慢，不适于随机存取；可靠性问题，入指针出错；
更多的寻道次数和寻道时间;链接指针占用一定的空间
链接结构的一个变形：文件分配表FAT(表项0，下一块块号，-1）
3.索引结构
a. 一个文件的信息存放在若干不连续物理块中
b. 系统为每个文件简历一个专用数据结构-索引表，并将这些物理块的块号存放在该索引表中
c. 索引表就是磁盘块地址数据，其中第i个条目指向文件的第i块
优点：保持了链接结构的优点，又解决了其缺点；既能顺序存取，又能随机存取
；满足了文件动态增长，插入删除的要求；能充分利用磁盘空间
缺点：较多的寻道次数和寻道时间；索引表本身带来了系统开销（如
内存，磁盘空间，存取时间）


索引表的组织方式
问题：索引表很大，需要多个物理块存放时怎么办？
1. 链接方式：一个盘块存一个索引表，多个索引表链接起来
2. 多级索引方式：将文件的索引表地址放在另一个索引表中
3. 综合模式： 直接索引方式与间接索引方式结合

多级索引与综合索引
三级索引：顶级索引表（指向次级索引表的地址）-》次级索引表（指向下一级索引表的地址）
综合模式：顶级索引表（前面2个索引项 直接指向物理地址，后面...指向次级索引表的地址）...

UNIX三级索引结构
unix文件系统采用的是多级索引结构（综合模式）
* 每个文件的主索引表有15个索引项（FCB中），每项2个字节
* 前12项直接存放文件的物理块号（直接寻址）
* 如果文件大于12块，则利用第13项指向一个物理块，在该块中存放的是一级索引表
（假设扇区大小为512字节，物理块等于扇区块大小，一级索引表可以存放256个物理块）
* 对于更大的文件还可以利用第14和第15项作为二级和三级索引表

问：采用这种结构，一个文件最大可达到？个物理块
12 + 256 + 256 * 256 + 256 * 256 * 256 

文件系统的实现

1. 实现文件系统需要考虑
磁盘上 与 内存中的 内容布局
2. 磁盘上（如何启动操作系统？磁盘是怎样管理的？怎样获取磁盘的有关信息？
目录文件在磁盘上怎么存放？普通文件在磁盘上怎么存放？）
3. 内存中（当进程使用文件时，操作系统是如何支持的？文件系统的内存数据结构）

相关术语
* 磁盘分区（partition）： 把一个物理磁盘的存储空间划分为几个相互独立的部分，称为分区
* 文件卷（volumn): 磁盘的逻辑分区，由一个或多个物理块（簇）组成。
1. 一个文件卷可以是整个磁盘，或部分磁盘，或夸盘（raid）
2. 同一个文件卷中使用同一份管理数据进行文件分配和磁盘空间管理，不同的文件卷中的管理数据是相互独立的。
3. 一个文件卷上：包括文件系统信息，一组文件（用户文件，目录文件，未分配空间）
4. 块block，或簇cluster：一个或多个（2的幂次方）连续的扇区，可寻址数据块
* 格式化（format): 在一个文件卷上建立文件系统，即建立并初始化用户文件分配和磁盘空间
管理的管理数据

磁盘的内容布局
文件卷（逻辑分区）
1. 引导区：包括了从该卷引导操作系统所需要的信息，每个卷（分区）一个，通常为第一个扇区
2. 卷（逻辑分区）信息：包括该卷（分区）的块（簇）数/大小，空闲块（簇）数量和指针，空闲FCB数量和指针...
3. 目录文件（根目录文件及其他目录文件）
4. 用户文件

unix 文件系统布局
文件卷（逻辑分区）：引导区，超级数据块，空闲区管理，i-节点区，根目录区，文件和目录区
windows文件系统布局
引导区，文件分配表1（链指针存放），文件分配表2，根目录，其他目录和文件

文件在内存中所需要的数据结构unix
1. 系统打开文件表
a. 整个系统一张
b. 放在内存：用于保存已打开文件的FCB
FCB(i节点）信息，引用计数，修改标记
2. 用户打开文件表
a. 每个进程一个
b. 进程的PCB中记录了用户打开文件表的位置
文件描述符，打开方式，读写指针，系统打开文件表索引（找到系统打开文件的FCB信息）

文件系统实例unix 

访问一个文件-》两步骤（文件名-〉文件目录——FCB-磁盘）
1. 目录检索
用户给出文件名-》按文件名查找到目录项/FCB
根据路径名检索：
全路径名：从根开始\A\B\C\File1
相对路径名：从当前目录开始C\File1
2. 文件寻址
根据目录项\FCB中文件物理地址等信息，计算出文件中任意记录或字符在存储介质上的地址

如何加快目录检索？
1. 一种解决方案：目录项分解法（FCB分成两部分）
a. 符号目录项（文件名，文件号）
b. 基本目录项（除文件名外的所有字段）
例子：unix 的i节点（索引节点或inode)
例子：假设一个FCB占48个字节，物理块大小512个字节，符号目录项占
8个字节（文件名6字节，文件号2字节），基本目录项占42个字节。
一个目录文件由128个目录项，分解前占13块，分解后（符号文件占2块，基本文件占11块）
查找一个文件的平均访盘次数： 分解前7次（1+13）/2，分解后2.5次（3.5次）（1+2）/2 +1 

unix文件系统
1. FCB = 目录项 + i 节点
2. 目录项 ： 文件名+i节点
3. 目录文件由目录项构成
4. i节点： 描述文件的相关信息
5. 每个文件由一个目录项，一个i节点和若干磁盘块构成
引导记录，超级数据块，空闲区管理，i节点，根目录区，文件和目录区
例子：/usr/ast/mbox的查找
查找usr目录文件对应的目录项-》根目录读入内存-〉找到i节点-》i节点区-〉记录第一块存放的磁盘地址-》
将usr目录文件读入内存-〉该块信息中查找ast对应目录项&i节点号-》i 节点区-〉ast保存的磁盘地址-》
将ast目录文件读入内存-〉该块信息中查找mbox对应的目录项&i节点-》... 


作业
第 3 个问题
文件系统实现文件的按名存取是通过下列哪一项工作完成的？ c 
a.目录项分解
b.文件寻址
c.文件目录查找
d.位示图查找
解答：文件目录是实现用户按名存取文件的一种手段。在用户要求读一个文件时，系统便从文件目录中查找用户所指定文件是否存在，
并核对是否有权使用。一个好的目录结构应该既能方便用户的检索，又能保证文件的安全
5.
第 5 个问题
下列关于文件目录及实现的叙述中，哪一个是不正确的？d

a.目录项分解法可以加快文件的目录检索速度
b.文件目录是文件控制块的有序集合
c.从当前目录开始查找文件可以提高文件的检索速度
d.树形目录结构存储在磁盘上对应了一个目录文件
解析：树形目录结构是逻辑结构
6.
第 6 个问题
某文件系统空间的最大容量为4TB(1T=240)，以磁盘块为基本分配单位，磁盘块大小为1KB。
文件控制块(FCB)包含一个512B的索引表。如果索引表只采用直接索引结构，存放文件占用的磁盘块号。在该文件系统中，
单个文件最大长度为多少块? d

a.64
b.256
c.512
d.128
解析：文件系统中所能容纳的磁盘块总数为 4TB/1KB=232 。要完全表示所有磁盘块，索引项中要存储这些块号数最少要占 32bit/8bit=4Byte 。
而索引表区仅采用直接索引结构，故 512B 的索引表区能容纳 512B/4B=128 个索引项。
每个索引项对应一个磁盘块，所以该系统可支持的单个文件最大长度是 128 × 1KB=128KB 。
7.
第 7 个问题
下列哪一项不需要记录在用户打开文件表中？a.
a.共享计数
b.文件描述符
c.读写指针
d.系统打开文件表入口指针
解析： 共享计数是系统打开文件表中的
8.
第 8 个问题
某文件系统把UNIX的三级索引结构改进为四级索引结构，假设物理块的大小为1KB，用4字节索引一个物理块号。
主索引表含有10个4字节的物理地址块指针，其中前6个为直接索引，第7个为一级索引，
第8个为二级索引，第9个为三级索引，第10个为四级索引。那么，该文件系统中一个文件最多可以有多少个文件块？a

a.6+2^8+2^16+2^24+2^32
b.6+2^7+2^14+2^21+2^28
c.6+2^10+2^20+2^30+2^40
d.6+2^9+2^18+2^27+2^36
解析：1kb/4 = 256块，四级索引 6+2^8 + 2^8*2^8 +  2^8*2^8* 2^8


9.
第 9 个问题
在实现文件系统时，可采用“目录项分解法”加快文件目录的检索速度。假设当前文件存放在磁盘上，
物理块大小为1024字节，文件控制块(FCB)大小为128字节，其中文件名占用16字节。目录项分解后，
符号部分占20字节（包括文件名和内部索引号），基本信息部分占112字节（包括文件索引号和其他信息）。
假设某一目录文件共有254个文件控制块，则采用“目录项分解法”前，查找该目录文件的某一个文件控制块的平均访盘次数是 c

a.15.5
b.17.5
c.16.5
d.14.5
解析：目录分解前，使用的块数 128*254/1024  = 32块，平均访盘次数 （1+32）/2 = 16.5

11.
第 11 个问题
下列关于文件索引结构的叙述中，哪些是正确的？ a,b,c,e
a.索引结构的优点是访问速度快，文件长度可以动态改
b.系统为每个文件建立一张索引表
c.从文件控制块中可以找到索引表或索引表的地址
d.采用索引结构，逻辑上连续的文件存放在连续的物理块中
e.采用索引结构会引入存储开销

12.
第 12 个问题
下列关于文件卷的叙述中，哪些是正确的？ abde
a.同一文件卷使用同一份管理数据(元数据)
b.文件卷可以建立在磁盘分区上
c.FAT文件系统的文件卷信息仅保存在文件分配表中
d.格式化是在一个逻辑分区上建立管理数据的过程
e.UNIX的文件卷信息存放在超级数据块、空闲空间管理区
解析： FAT文件系统的文件卷信息 引导扇区中

14.
第 14 个问题
在文件系统中，文件的逻辑块与存储介质上物理块存放顺序一致的物理结构是索引结构。F
















