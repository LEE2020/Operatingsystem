文件管理
* 文件与文件系统
* 文件的存储介质
* 磁盘空间管理
* 文件控制块及文件目录
* 文件的物理结构
* 文件系统的实现
* 文件系统实例unix


文件与文件系统

文件是磁盘的抽象，是指一组带标识（标识即为文件名）的，在逻辑上有完整意义的信息项的序列。
信息项：构成文件内容的基本单位（单个字节或多个字节），各个信息项之间具有顺序关系。
文件内容的意义：由文件建立者和使用者解释
（信息项0，信息项1，信息项2，...,信息项n-1)
读写指针指向某个信息项

如何设计一个文件系统？

用户角度：文件系统如何呈现在用户面前（一个文件的组织，命名，保护文件，实施操作）
操作系统：组织，管理文件（文件的描述，分类；文件目录的实现，存储空间的管理，文件的物理地址，
磁盘实际运作方式（与设备管理的接口），文件系统性能）

文件系统

操作系统中统一管理信息资源的一种软件，管理文件的存储，检索，更新，提供安全可靠的共享和保护手段，并且方便用户使用。
*统一管理磁盘空间，实施磁盘空间的分配与回收
*实现文件的按名存取（名字空间 映射 磁盘空间）
*实现文件信息的共享，并提供文件的保护，保密手段
*向用户提供一个方便使用，易于维护的接口，并向用户提供有关统计信息
*提高文件系统的性能
*提供与I/O系统的统一接口

文件的分类（UNIX) 按照文件性质和用途分类

普通文件regular: 包含了用户的信息，一般为ASCII或二进制文件
目录文件directory:管理文件系统的系统文件
特殊文件special file:字符设备文件：和输入输出有关，用于模仿串行I/O设备，
例如终端，打印机，网卡等；块设备文件：磁盘

文件的逻辑结构（用户角度看文件，由用户的访问方式确定）

典型的文件逻辑结构和文件存取
* 流式文件：构成文件的基本单位是字符
文件是有逻辑意义，无结构的一串字符的集合
*记录式文件：文件由若干个记录组成，可以按记录进行读，写查找等操作
每条记录有其内部结构
1. 顺序存取
2. 随机存取（提供读写位置（当前位置）例如unix seek操作）

文件的存储介质

* 典型的存储介质
磁盘（包括固态盘ssd),磁带，光盘，u盘等
* 物理块（块block，簇cluster）
1. 信息存储，传输，分配的独立单位
2. 存储设备划分为大小相等的物理块，统一编号
例如：典型磁盘结构
任何时刻只有一个磁头处于活动状态：输入输出数据流以位串形式出现
物理地址形式：磁头号（盘面号），磁道号（柱面号），扇区号
扇区：标题（10字节），数据（512字节），ECC纠错信息（12-16字节）

磁盘访问

一次访盘请求：
读/写，磁盘地址（设备号，柱面号，磁头号，扇区号），内存地址（源/目）
完成这个过程由三个动作组成：
1.寻道（时间）： 磁头移动定位到指定磁道
2. 旋转延迟（时间）： 等待指定扇区从磁头下方经过
3. 数据传输（时间）：数据在磁盘与内存之间的实际传输

磁盘空间管理

相关的数据结构
1. 位图
a. 用一串二进制位反映磁盘空间中分配使用情况，每个物理块对应一位，分配的物理块为0，否则为1
b. 申请物理块时，可以在位示图中查找为1的位，返回对应物理块号
c. 归还时，将对应位转置1
2. 空闲块表
a. 将所有空闲块记录在一个表中，即空闲块表
b. 主要两项内容：起始块号，块数
3. 空闲块链表
a. 把所有空闲块链成一个链
b. 扩展：成组链接法

磁盘地址与块号的转换
已知块号，则磁盘地址：
柱面号=【块号/（磁头数 x 扇区数）】
磁头号=【（块号mod(磁头数 x 扇区数））/扇区数】
扇区号=（块号mod(磁头数 x 扇区数）mod 扇区数
已知磁盘地址：
块号=柱面号 x (磁头数 x 扇区数） + 磁头号 x 扇区数 + 扇区号
位图计算公式：
已知字号i,位号j: 块号=ix字长+j
已知块号：字号=【块号/字长】 位号=块号mod字长

UNIX成组链接法-分配算法（分配一个空闲块）
查L单元（空闲块数）
a. 当空闲块数>1 i=L+空闲块数；从i单元得到一个空闲块号；把该块分配给申请者；空闲块数减1
b. 当空闲块数=1 取出L+1单元内容（一组的第一块号或0）；其值=0无空闲块号，申请者等待，
其值不等于零，把该块内容复制到专用块，该块分配给申请者；把专用块内容读到内存L开始的区域

UNIX成组链接法-回收算法（归还一个块）
查L单元的空闲块数
a. 当空闲块数<100 空闲块数加1； j:=L+空闲块数；归还块号填入j单元。
b. 当空闲块数=100 则把内存中登记的信息写入归还块中；把归还块号填入L+1单元，
将L单元置成1。


文件控制块和文件目录
1. 文件控制块（File Control Block)
为管理文件而设置的数据结构，保存管理文件所需的所有有关信息
（文件属性或元数据）
2. 常用属性
文件名，文件号，文件大小，文件地址，创建时间，最后修改时间，最后访问时间
保护，口令，创建者，当前拥有者，文件类型，共享计数，各种标志（
（只读，隐藏，系统，归档，ASCII/二进制，顺序/随机访问，临时文件，锁）

基本文件操作
create, delete, open, close, read, write
append, seek, get attribute, set attribute, rename

文件目录，目录项与目录文件

文件目录
1. 统一管理每个文件的元数据，以支持文件名到文件物理地址的转换
2. 将所有文件的管理信息组织在一起，即构成文件目录
目录文件
1. 将文件目录以文件的形式存放在磁盘
目录项
1. 构成文件目录的基本单元
2. 目录项可以是FCB, 目录是文件控制块的有序集合

文件目录结构的演化
一级目录结构-》二级目录结构-〉树形目录结构（当前）

与目录相关的概念
1. 路径名（文件名）
a. 绝对路径名：从根目录开始
b. 相对路径名：从当前目录开始
2. 当前目录/工作目录
3. 目录操作
a. 创建目录，删除目录
b. 读目录，写目录，改名，复制

目录文件之间的关联

文件的物理结构
文件在存储介质上的存放方式
主要解决两个问题：
1. 假设一个文件被划分成N块，这N块在磁盘上是怎么存放的？
2. 其地址（块号/簇号）在FCB中是怎么记录的？
1.连续（顺序）结构
a. 文件的信息存放在若干连续的物理块中
优点：简单；支持顺序存取和随机存取；所需的磁盘寻道次数和寻道时间最少；
可以同时读入多个块，检索一个块也很容易
缺点：文件不能动态增长，预留空间：浪费或者重新分配和移动；不利于文件插入和删除；
外部碎片：紧缩技术
2.链接结构
a. 一个文件的信息存放在若干个不连续的物理块中，各块之间通过指针连接，前一个
物理块指向下一个物理块
优点：提高了磁盘空间利用率，不存在外碎片问题；有利于文件插入和删除；
有利于文件动态扩充
缺点：存取速度慢，不适于随机存取；可靠性问题，入指针出错；
更多的寻道次数和寻道时间;链接指针占用一定的空间
链接结构的一个变形：文件分配表FAT(表项0，下一块块号，-1）
3.索引结构
a. 一个文件的信息存放在若干不连续物理块中
b. 系统为每个文件简历一个专用数据结构-索引表，并将这些物理块的块号存放在该索引表中
c. 索引表就是磁盘块地址数据，其中第i个条目指向文件的第i块
优点：保持了链接结构的优点，又解决了其缺点；既能顺序存取，又能随机存取
；满足了文件动态增长，插入删除的要求；能充分利用磁盘空间
缺点：较多的寻道次数和寻道时间；索引表本身带来了系统开销（如
内存，磁盘空间，存取时间）


索引表的组织方式
问题：索引表很大，需要多个物理块存放时怎么办？
1. 链接方式：一个盘块存一个索引表，多个索引表链接起来
2. 多级索引方式：将文件的索引表地址放在另一个索引表中
3. 综合模式： 直接索引方式与间接索引方式结合

多级索引与综合索引
三级索引：顶级索引表（指向次级索引表的地址）-》次级索引表（指向下一级索引表的地址）
综合模式：顶级索引表（前面2个索引项 直接指向物理地址，后面...指向次级索引表的地址）...

UNIX三级索引结构
unix文件系统采用的是多级索引结构（综合模式）
* 每个文件的主索引表有15个索引项（FCB中），每项2个字节
* 前12项直接存放文件的物理块号（直接寻址）
* 如果文件大于12块，则利用第13项指向一个物理块，在该块中存放的是一级索引表
（假设扇区大小为512字节，物理块等于扇区块大小，一级索引表可以存放256个物理块）
* 对于更大的文件还可以利用第14和第15项作为二级和三级索引表

问：采用这种结构，一个文件最大可达到？个物理块
12 + 256 + 256 * 256 + 256 * 256 * 256 

文件系统的实现

1. 实现文件系统需要考虑
磁盘上 与 内存中的 内容布局
2. 磁盘上（如何启动操作系统？磁盘是怎样管理的？怎样获取磁盘的有关信息？
目录文件在磁盘上怎么存放？普通文件在磁盘上怎么存放？）
3. 内存中（当进程使用文件时，操作系统是如何支持的？文件系统的内存数据结构）

相关术语
* 磁盘分区（partition）： 把一个物理磁盘的存储空间划分为几个相互独立的部分，称为分区
* 文件卷（volumn): 磁盘的逻辑分区，由一个或多个物理块（簇）组成。
1. 一个文件卷可以是整个磁盘，或部分磁盘，或夸盘（raid）
2. 同一个文件卷中使用同一份管理数据进行文件分配和磁盘空间管理，不同的文件卷中的管理数据是相互独立的。
3. 一个文件卷上：包括文件系统信息，一组文件（用户文件，目录文件，未分配空间）
4. 块block，或簇cluster：一个或多个（2的幂次方）连续的扇区，可寻址数据块
* 格式化（format): 在一个文件卷上建立文件系统，即建立并初始化用户文件分配和磁盘空间
管理的管理数据

磁盘的内容布局
文件卷（逻辑分区）
1. 引导区：包括了从该卷引导操作系统所需要的信息，每个卷（分区）一个，通常为第一个扇区
2. 卷（逻辑分区）信息：包括该卷（分区）的块（簇）数/大小，空闲块（簇）数量和指针，空闲FCB数量和指针...
3. 目录文件（根目录文件及其他目录文件）
4. 用户文件






















